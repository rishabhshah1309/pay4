<h1>Upload Receipt for #{{ receipt.id }}</h1>
<input id="file" type="file" accept="image/*,application/pdf">
<button id="btn">Upload to S3</button>
<p id="msg"></p>
<p><a id="process" href="{% url 'process_receipt' receipt.id %}" style="display:none">Process with Textract</a></p>

<script>
async function presign(contentType) {
  const res = await fetch("{% url 'presign' receipt.id %}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({content_type: contentType})
  });
  if (!res.ok) throw new Error("presign failed");
  return await res.json();
}

document.getElementById("btn").onclick = async () => {
  const f = document.getElementById("file").files[0];
  if (!f) { alert("Pick a file"); return; }
  const post = await presign(f.type || "application/octet-stream");
  const fd = new FormData();
  Object.entries(post.fields).forEach(([k, v]) => fd.append(k, v));
  fd.append("key", post.fields.key || "{{ receipt.s3_key|default:'' }}");
  fd.append("file", f);
  const up = await fetch(post.url, { method: "POST", body: fd });
  if (up.ok) {
    document.getElementById("msg").textContent = "Uploaded! Now process.";
    document.getElementById("process").style.display = "inline";
  } else {
    document.getElementById("msg").textContent = "Upload failed.";
  }
};
</script>
